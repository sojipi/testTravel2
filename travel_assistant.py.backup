import gradio as gr
import json
import os
from typing import Tuple, List
from openai import OpenAI
import requests
from PIL import Image
from io import BytesIO
import base64
import asyncio
from datetime import datetime

# é…ç½®APIå¯†é’¥ - è¯·ç›´æ¥ä¿®æ”¹è¿™é‡Œçš„é…ç½®
# è·å–APIå¯†é’¥: https://api.minimax.chat/
API_KEY = ""  # <-- åœ¨è¿™é‡Œå¡«å…¥æ‚¨çš„APIå¯†é’¥
BASE_URL = "https://api-inference.modelscope.cn/v1/"  # API Base URL
MODEL_NAME = "MiniMax/MiniMax-M2"  # æ¨¡å‹åç§°ï¼Œå¯ä»¥æ˜¯ abab6.5s-chat, abab6.5g-chat ç­‰

# åˆå§‹åŒ–OpenAIå®¢æˆ·ç«¯
def init_openai_client():
    client = OpenAI(
        base_url=BASE_URL,
        api_key=API_KEY,
    )
    return client

# å…¨å±€å˜é‡å­˜å‚¨æ¨èç»“æœ
destination_recommendations = []
itinerary_plans = []
checklist_items = []

def generate_destination_recommendation(
    season: str,
    health_condition: str,
    budget: str,
    interests: str
) -> Tuple[str, str]:
    """ç”Ÿæˆç›®çš„åœ°æ¨è"""
    client = init_openai_client()

    system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è€å¹´æ—…è¡Œè§„åˆ’å¸ˆï¼Œä¸“é—¨ä¸º55å²ä»¥ä¸Šçš„è€å¹´äººæ¨èåˆé€‚çš„æ—…è¡Œç›®çš„åœ°ã€‚
è¯·æ ¹æ®ç”¨æˆ·çš„å­£èŠ‚ã€å¥åº·çŠ¶å†µã€é¢„ç®—å’Œå…´è¶£ï¼Œæ¨è3-5ä¸ªå›½å†…å¤–çƒ­é—¨é€‚è€ç›®çš„åœ°ã€‚
æ¯ä¸ªæ¨èåº”åŒ…æ‹¬ï¼š
1. ç›®çš„åœ°åç§°
2. æ¨èç†ç”±ï¼ˆæ°”å€™èˆ’é€‚ã€æ— éšœç¢è®¾æ–½å®Œå–„ã€åŒ»ç–—æ¡ä»¶å¥½ç­‰ï¼‰
3. æœ€ä½³æ—…è¡Œæ—¶é•¿
4. æ³¨æ„äº‹é¡¹

è¯·ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€å›å¤ï¼Œé¿å…ä½¿ç”¨è¿‡äºä¸“ä¸šçš„æœ¯è¯­ã€‚"""

    user_prompt = f"""
è¯·ä¸ºæˆ‘æ¨èæ—…è¡Œç›®çš„åœ°ï¼š
- å­£èŠ‚ï¼š{season}
- å¥åº·çŠ¶å†µï¼š{health_condition}
- é¢„ç®—ï¼š{budget}
- å…´è¶£åå¥½ï¼š{interests}

è¯·æ¨è3-5ä¸ªç›®çš„åœ°ï¼Œæ¯ä¸ªæ¨èåŒ…å«è¯¦ç»†ä¿¡æ¯ã€‚"""

    reasoning_content = ""
    final_content = ""

    try:
        response = client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}
            ],
            stream=True
        )

        reasoning_done = False
        for chunk in response:
            reasoning_chunk = chunk.choices[0].delta.reasoning_content
            answer_chunk = chunk.choices[0].delta.content

            if reasoning_chunk:
                reasoning_content += reasoning_chunk
            elif answer_chunk:
                if not reasoning_done:
                    final_content += "\n\n=== æ¨èç»“æœ ===\n\n"
                    reasoning_done = True
                final_content += answer_chunk

    except Exception as e:
        reasoning_content = f"[æ€è€ƒè¿‡ç¨‹] æ­£åœ¨åˆ†æç”¨æˆ·éœ€æ±‚...\n\nå­£èŠ‚ï¼š{season}\nå¥åº·çŠ¶å†µï¼š{health_condition}\né¢„ç®—ï¼š{budget}\nå…´è¶£ï¼š{interests}"
        final_content = f"[é”™è¯¯] ç”Ÿæˆæ¨èæ—¶å‡ºé”™ï¼š{str(e)}\n\nè¯·æ£€æŸ¥APIé…ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚"

    return reasoning_content, final_content

def generate_itinerary_plan(
    destination: str,
    duration: str,
    mobility: str,
    health_focus: str
) -> Tuple[str, str]:
    """ç”Ÿæˆè¯¦ç»†è¡Œç¨‹è§„åˆ’"""
    client = init_openai_client()

    system_prompt = """ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„è€å¹´æ—…è¡Œè¡Œç¨‹è§„åˆ’å¸ˆã€‚
è¯·ä¸ºè€å¹´äººåˆ¶å®šèˆ’ç¼“ã€è´´å¿ƒçš„æ—¥è¡Œç¨‹å®‰æ’ï¼Œç‰¹åˆ«æ³¨æ„ï¼š
1. èŠ‚å¥èˆ’ç¼“ï¼Œæ¯å¤©ä¸è¶…è¿‡2-3ä¸ªä¸»è¦æ´»åŠ¨
2. åŒ…å«æ— éšœç¢è®¾æ–½ä¿¡æ¯
3. æ ‡æ³¨é™„è¿‘çš„åŒ»é™¢æˆ–è¯åº—ä½ç½®
4. é¢„ç•™å……è¶³çš„ä¼‘æ¯æ—¶é—´
5. è€ƒè™‘è€å¹´äººä½œæ¯ä¹ æƒ¯ï¼ˆæ—©èµ·ã€åˆä¼‘ï¼‰

ç”¨é€šä¿—æ˜“æ‡‚çš„è¯­è¨€æè¿°ï¼Œé¿å…è¿‡äºç´§å‡‘çš„è¡Œç¨‹ã€‚"""

    user_prompt = f"""
è¯·ä¸ºä»¥ä¸‹ç›®çš„åœ°åˆ¶å®š{duration}çš„è¯¦ç»†è¡Œç¨‹ï¼š
- ç›®çš„åœ°ï¼š{destination}
- è¡ŒåŠ¨èƒ½åŠ›ï¼š{mobility}
- å¥åº·å…³æ³¨ç‚¹ï¼š{health_focus}

è¯·æŒ‰å¤©åˆ¶å®šè¡Œç¨‹ï¼Œæ¯å¤©åŒ…å«ï¼šæ—¶é—´å®‰æ’ã€æ´»åŠ¨å†…å®¹ã€äº¤é€šæ–¹å¼ã€ä½å®¿æ¨èã€æ³¨æ„äº‹é¡¹ã€‚"""

    reasoning_content = ""
    final_content = ""

    try:
        response = client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}
            ],
            stream=True
        )

        reasoning_done = False
        for chunk in response:
            reasoning_chunk = chunk.choices[0].delta.reasoning_content
            answer_chunk = chunk.choices[0].delta.content

            if reasoning_chunk:
                reasoning_content += reasoning_chunk
            elif answer_chunk:
                if not reasoning_done:
                    final_content += "\n\n=== è¡Œç¨‹è§„åˆ’ ===\n\n"
                    reasoning_done = True
                final_content += answer_chunk

    except Exception as e:
        reasoning_content = f"[æ€è€ƒè¿‡ç¨‹] æ­£åœ¨ä¸º{destination}åˆ¶å®šè¡Œç¨‹...\n\næ—…è¡Œæ—¶é•¿ï¼š{duration}\nè¡ŒåŠ¨èƒ½åŠ›ï¼š{mobility}\nå¥åº·å…³æ³¨ï¼š{health_focus}"
        final_content = f"[é”™è¯¯] ç”Ÿæˆè¡Œç¨‹æ—¶å‡ºé”™ï¼š{str(e)}\n\nè¯·æ£€æŸ¥APIé…ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚"

    return reasoning_content, final_content

def generate_checklist(destination: str, duration: str, special_needs: str) -> Tuple[str, str]:
    """ç”Ÿæˆè¡Œå‰æ£€æŸ¥æ¸…å•"""
    client = init_openai_client()

    system_prompt = """ä½ æ˜¯ä¸€ä¸ªç»†å¿ƒçš„è€å¹´æ—…è¡ŒåŠ©æ‰‹ã€‚
è¯·ä¸ºè€å¹´äººåˆ¶å®šè¯¦ç»†çš„è¡Œå‰å‡†å¤‡æ¸…å•ï¼ŒåŒ…æ‹¬ï¼š

å¿…å¸¦ç‰©å“ï¼š
- è¯ä»¶ç±»ï¼ˆèº«ä»½è¯ã€åŒ»ä¿å¡ã€è€å¹´è¯ç­‰ï¼‰
- è¯å“ç±»ï¼ˆå¸¸ç”¨è¯ã€æ€¥æ•‘è¯ã€å¤„æ–¹è¯ç­‰ï¼‰
- è¡£ç‰©ç±»ï¼ˆæ ¹æ®ç›®çš„åœ°çš„æ°”å€™å‡†å¤‡ï¼‰
- ç”¨å“ç±»ï¼ˆè€èŠ±é•œã€åŠ©å¬å™¨ã€æ‹æ–ã€é›¨ä¼ç­‰ï¼‰

å¯é€‰ç‰©å“ï¼š
- å¨±ä¹ç”¨å“ï¼ˆä¹¦ç±ã€ç›¸æœºã€è±¡æ£‹ç­‰ï¼‰
- ä¿å¥ç”¨å“ï¼ˆè¡€å‹è®¡ã€è¡€ç³–ä»ªã€æŒ‰æ‘©å™¨ç­‰ï¼‰

è¯·ç”¨å¤§å­—ä½“ã€æ¸…æ™°çš„æ ¼å¼å±•ç¤ºï¼Œæ–¹ä¾¿è€å¹´äººé˜…è¯»å’Œå‹¾é€‰ã€‚"""

    user_prompt = f"""
è¯·ä¸ºä»¥ä¸‹æ—…è¡Œå‡†å¤‡è¡Œå‰æ¸…å•ï¼š
- ç›®çš„åœ°ï¼š{destination}
- æ—…è¡Œæ—¶é•¿ï¼š{duration}
- ç‰¹æ®Šéœ€æ±‚ï¼š{special_needs}

è¯·æŒ‰ç±»åˆ«åˆ†ç»„ï¼Œå¹¶æ ‡æ³¨å“ªäº›æ˜¯å¿…éœ€å“ï¼Œå“ªäº›æ˜¯å¯é€‰çš„ã€‚"""

    reasoning_content = ""
    final_content = ""

    try:
        response = client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': user_prompt}
            ],
            stream=True
        )

        reasoning_done = False
        for chunk in response:
            reasoning_chunk = chunk.choices[0].delta.reasoning_content
            answer_chunk = chunk.choices[0].delta.content

            if reasoning_chunk:
                reasoning_content += reasoning_chunk
            elif answer_chunk:
                if not reasoning_done:
                    final_content += "\n\n=== è¡Œå‰æ¸…å• ===\n\n"
                    reasoning_done = True
                final_content += answer_chunk

    except Exception as e:
        reasoning_content = f"[æ€è€ƒè¿‡ç¨‹] æ­£åœ¨ä¸º{destination}å‡†å¤‡æ¸…å•...\n\næ—…è¡Œæ—¶é•¿ï¼š{duration}\nç‰¹æ®Šéœ€æ±‚ï¼š{special_needs}"
        final_content = f"[é”™è¯¯] ç”Ÿæˆæ¸…å•æ—¶å‡ºé”™ï¼š{str(e)}\n\nè¯·æ£€æŸ¥APIé…ç½®æˆ–ç½‘ç»œè¿æ¥ã€‚"

    return reasoning_content, final_content

def generate_travel_story(
    photos: List[Image.Image],
    custom_input: str = ""
) -> Tuple[str, str]:
    """ç”Ÿæˆå¤šæ¨¡æ€æ—…è¡Œæ¸¸è®°"""
    client = init_openai_client()

    # å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64ç¼–ç 
    photo_descriptions = []
    for idx, photo in enumerate(photos, 1):
        buffered = BytesIO()
        photo.save(buffered, format='JPEG')
        img_str = base64.b64encode(buffered.getvalue()).decode()

        # è¿™é‡Œéœ€è¦ä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹ï¼Œä½†è€ƒè™‘åˆ°ç¤ºä¾‹ä¸­åªæœ‰æ–‡æœ¬æ¨¡å‹
        # æˆ‘ä»¬å…ˆç”¨æ–‡æœ¬æç¤ºç”¨æˆ·ä¸Šä¼ äº†å“ªäº›å›¾ç‰‡
        photo_descriptions.append(f"ç¬¬{idx}å¼ ç…§ç‰‡ï¼šç”¨æˆ·ä¸Šä¼ çš„æ—…è¡Œç…§ç‰‡")

    system_prompt = """ä½ æ˜¯ä¸€ä¸ªæ¸©æš–çš„è€å¹´æ—…è¡Œæ•…äº‹è®²è¿°è€…ã€‚
è¯·æ ¹æ®ç”¨æˆ·ä¸Šä¼ çš„ç…§ç‰‡å’Œè¾“å…¥çš„æ–‡å­—ï¼Œä¸ºè€å¹´äººç”Ÿæˆä¸€ç¯‡æ¸©é¦¨ã€æ„Ÿäººçš„æ—…è¡Œæ¸¸è®°ã€‚
è¦æ±‚ï¼š
1. è¯­è¨€äº²åˆ‡æ¸©é¦¨ï¼Œç¬¦åˆè€å¹´äººçš„é˜…è¯»ä¹ æƒ¯
2. å›å¿†ç¾å¥½æ—¶å…‰ï¼Œå……æ»¡æ­£èƒ½é‡
3. å¯ä»¥é€‚å½“åŠ å…¥äººç”Ÿæ„Ÿæ‚Ÿå’Œå“²ç†
4. ç»“æ„æ¸…æ™°ï¼Œæ¯å¼ ç…§ç‰‡å¯¹åº”ä¸€æ®µæè¿°
5. ç¯‡å¹…é€‚ä¸­ï¼Œçº¦300-500å­—"""

    user_prompt = f"""
è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆæ—…è¡Œæ¸¸è®°ï¼š
{chr(10).join(photo_descriptions)}

ç”¨æˆ·è¡¥å……ä¿¡æ¯ï¼š{custom_input}

è¯·ç”Ÿæˆä¸€ç¯‡å®Œæ•´çš„æ—…è¡Œæ¸¸è®°ã€‚"""

    response = client.chat.completions.create(
        model=MODEL_NAME,
        messages=[
            {'role': 'system', 'content': system_prompt},
            {'role': 'user', 'content': user_prompt}
        ],
        stream=True
    )

    reasoning_done = False
    story_content = ""
    for chunk in response:
        reasoning_chunk = chunk.choices[0].delta.reasoning_content
        answer_chunk = chunk.choices[0].delta.content

        if reasoning_chunk:
            story_content += reasoning_chunk
        elif answer_chunk:
            if not reasoning_done:
                story_content += "\n\n=== æ—…è¡Œæ¸¸è®° ===\n\n"
                reasoning_done = True
            story_content += answer_chunk

    # ç”Ÿæˆè§†é¢‘prompt
    video_prompt = f"Create a heartwarming travel memory video with gentle transitions, soft background music, and elegant text overlays. Style: vintage, warm colors, comfortable pace."

    return story_content, video_prompt

def generate_image_from_prompt(prompt: str) -> List[Image.Image]:
    """æ ¹æ®promptç”Ÿæˆå›¾ç‰‡"""
    # å›¾ç‰‡ç”ŸæˆAPIé…ç½® - è¯·æ ¹æ®æ‚¨çš„å›¾ç‰‡ç”ŸæˆæœåŠ¡ä¿®æ”¹
    IMAGE_API_URL = "https://api-inference.modelscope.cn/v1/images/generations"
    IMAGE_MODEL = "djyzcp123/gjerc"

    payload = {
        'model': IMAGE_MODEL,
        'prompt': prompt
    }
    headers = {
        'Authorization': f'Bearer {API_KEY}',
        'Content-Type': 'application/json'
    }

    try:
        response = requests.post(
            IMAGE_API_URL,
            data=json.dumps(payload, ensure_ascii=False).encode('utf-8'),
            headers=headers
        )

        response_data = response.json()
        images = []

        for img_data in response_data.get('images', []):
            img_response = requests.get(img_data['url'])
            img = Image.open(BytesIO(img_response.content))
            # è°ƒæ•´å°ºå¯¸ä¸º1024x500
            img = img.resize((1024, 500), Image.Resampling.LANCZOS)
            images.append(img)

        return images
    except Exception as e:
        print(f"Image generation error: {e}")
        return []

def regenerate_image(prompt: str) -> List[Image.Image]:
    """é‡æ–°ç”Ÿæˆå›¾ç‰‡"""
    return generate_image_from_prompt(prompt)

# åˆ›å»ºGradioç•Œé¢
def create_app():
    with gr.Blocks(
        title="ğŸ§³ é“¶å‘æ—æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹",
        theme=gr.themes.Soft(
            primary_hue="purple",
            secondary_hue="cyan",
            font=[gr.themes.GoogleFont("Microsoft YaHei"), "Arial", "sans-serif"]
        ),
        css="""
        .main-header {
            font-size: 48px !important;
            font-weight: bold !important;
            text-align: center !important;
            padding: 30px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px !important;
        }
        .section-title {
            font-size: 32px !important;
            font-weight: bold !important;
            color: #667eea !important;
            margin-top: 30px !important;
            margin-bottom: 20px !important;
        }
        .large-button {
            font-size: 24px !important;
            padding: 20px 40px !important;
            height: auto !important;
        }
        .large-input {
            font-size: 20px !important;
            padding: 15px !important;
        }
        .large-textbox {
            font-size: 20px !important;
            line-height: 1.8 !important;
        }
        .large-label {
            font-size: 24px !important;
            font-weight: 600 !important;
        }
        .output-box {
            font-size: 20px !important;
            line-height: 1.8 !important;
            padding: 20px !important;
            border: 3px solid #667eea !important;
            border-radius: 10px !important;
            background-color: #f8f9ff !important;
        }
        """,
        elem_id="main-app"
    ) as app:
        gr.HTML("""
        <div class="main-header">
            ğŸ§³ é“¶å‘æ—æ™ºèƒ½æ—…è¡ŒåŠ©æ‰‹
        </div>
        <p style="text-align: center; font-size: 24px; color: #666; margin-bottom: 40px;">
            ä¸“ä¸ºè€å¹´äººæ‰“é€ çš„æ™ºèƒ½æ—…è¡Œè§„åˆ’å¹³å° Â· è®©å‡ºè¡Œæ›´çœå¿ƒã€æ›´å®‰å…¨ã€æ›´æœ‰è¶£
        </p>
        """)

        with gr.Tabs() as tabs:
            # Tab 1: æ™ºèƒ½æ¨èä¸è§„åˆ’
            with gr.TabItem("ğŸŒ æ™ºèƒ½æ¨èä¸è§„åˆ’", id=1):
                gr.HTML('<div class="section-title">ğŸ—ºï¸ ç›®çš„åœ°æ¨è</div>')

                with gr.Row():
                    with gr.Column(scale=1):
                        season = gr.Dropdown(
                            choices=["æ˜¥å­£", "å¤å­£", "ç§‹å­£", "å†¬å­£"],
                            label="ğŸŒ¸ å­£èŠ‚",
                            value="ç§‹å­£",
                            elem_classes="large-input"
                        )
                        health_condition = gr.Dropdown(
                            choices=["èº«ä½“å¥åº·", "æœ‰æ…¢æ€§ç—…ä½†æ§åˆ¶è‰¯å¥½", "è¡ŒåŠ¨ä¸ä¾¿éœ€è¾…åŠ©", "éœ€è¦ç‰¹æ®ŠåŒ»ç–—å…³æ³¨"],
                            label="ğŸ¥ å¥åº·çŠ¶å†µ",
                            value="èº«ä½“å¥åº·",
                            elem_classes="large-input"
                        )
                        budget = gr.Dropdown(
                            choices=["ç»æµå®æƒ ï¼ˆ5000å…ƒä»¥ä¸‹ï¼‰", "èˆ’é€‚å‹ï¼ˆ5000-15000å…ƒï¼‰", "è±ªåå‹ï¼ˆ15000-30000å…ƒï¼‰", "ä¸é™é¢„ç®—"],
                            label="ğŸ’° é¢„ç®—èŒƒå›´",
                            value="èˆ’é€‚å‹ï¼ˆ5000-15000å…ƒï¼‰",
                            elem_classes="large-input"
                        )
                        interests = gr.Textbox(
                            label="ğŸ¨ å…´è¶£åå¥½",
                            placeholder="å¦‚ï¼šé¿å¯’ã€åº·å…»ã€è§‚å…‰ã€ç¾é£Ÿã€æ‘„å½±ã€æ–‡åŒ–ä½“éªŒç­‰",
                            value="é¿å¯’ã€åº·å…»",
                            elem_classes="large-input"
                        )
                        recommend_btn = gr.Button("ğŸ” æ¨èç›®çš„åœ°", variant="primary", elem_classes="large-button")

                    with gr.Column(scale=1):
                        recommendation_reasoning = gr.Textbox(
                            label="ğŸ¤” æ€è€ƒè¿‡ç¨‹",
                            lines=8,
                            max_lines=15,
                            elem_classes="large-textbox"
                        )
                        recommendation_output = gr.Textbox(
                            label="âœ¨ æ¨èç»“æœ",
                            lines=15,
                            max_lines=25,
                            elem_classes="output-box"
                        )

                recommend_btn.click(
                    fn=generate_destination_recommendation,
                    inputs=[season, health_condition, budget, interests],
                    outputs=[recommendation_reasoning, recommendation_output]
                )

                gr.HTML('<div class="section-title">ğŸ“… è¡Œç¨‹è§„åˆ’</div>')

                with gr.Row():
                    with gr.Column(scale=1):
                        destination = gr.Textbox(
                            label="ğŸ“ ç›®çš„åœ°",
                            placeholder="è¾“å…¥æ‚¨æƒ³å»çš„ç›®çš„åœ°",
                            elem_classes="large-input"
                        )
                        duration = gr.Dropdown(
                            choices=["3-5å¤©", "ä¸€å‘¨å·¦å³", "10-15å¤©", "åŠä¸ªæœˆä»¥ä¸Š"],
                            label="â° æ—…è¡Œæ—¶é•¿",
                            value="ä¸€å‘¨å·¦å³",
                            elem_classes="large-input"
                        )
                        mobility = gr.Dropdown(
                            choices=["è¡Œèµ°è‡ªå¦‚", "éœ€è¦å°‘é‡ä¼‘æ¯", "ä½¿ç”¨æ‹æ–æˆ–åŠ©è¡Œå™¨", "ä¸»è¦ä½¿ç”¨è½®æ¤…"],
                            label="ğŸš¶ è¡ŒåŠ¨èƒ½åŠ›",
                            value="è¡Œèµ°è‡ªå¦‚",
                            elem_classes="large-input"
                        )
                        health_focus = gr.Textbox(
                            label="â¤ï¸ å¥åº·å…³æ³¨ç‚¹",
                            placeholder="å¦‚ï¼šé«˜è¡€å‹ã€ç³–å°¿ç—…ã€å¿ƒè„ç—…ç­‰éœ€è¦ç‰¹åˆ«å…³æ³¨çš„äº‹é¡¹",
                            elem_classes="large-input"
                        )
                        itinerary_btn = gr.Button("ğŸ“‹ åˆ¶å®šè¡Œç¨‹", variant="primary", elem_classes="large-button")

                    with gr.Column(scale=1):
                        itinerary_reasoning = gr.Textbox(
                            label="ğŸ¤” æ€è€ƒè¿‡ç¨‹",
                            lines=8,
                            max_lines=15,
                            elem_classes="large-textbox"
                        )
                        itinerary_output = gr.Textbox(
                            label="âœ¨ è¡Œç¨‹å®‰æ’",
                            lines=15,
                            max_lines=25,
                            elem_classes="output-box"
                        )

                itinerary_btn.click(
                    fn=generate_itinerary_plan,
                    inputs=[destination, duration, mobility, health_focus],
                    outputs=[itinerary_reasoning, itinerary_output]
                )

            # Tab 2: æ¸…å•ä¸å¯¼æ¸¸æœåŠ¡
            with gr.TabItem("ğŸ“ æ¸…å•ä¸å¯¼æ¸¸æœåŠ¡", id=2):
                gr.HTML('<div class="section-title">âœ… è¡Œå‰å‡†å¤‡æ¸…å•</div>')

                with gr.Row():
                    with gr.Column(scale=1):
                        checklist_dest = gr.Textbox(
                            label="ğŸ“ ç›®çš„åœ°",
                            placeholder="è¯·è¾“å…¥æ—…è¡Œç›®çš„åœ°",
                            elem_classes="large-input"
                        )
                        checklist_duration = gr.Dropdown(
                            choices=["3-5å¤©", "ä¸€å‘¨å·¦å³", "10-15å¤©", "åŠä¸ªæœˆä»¥ä¸Š"],
                            label="â° æ—…è¡Œæ—¶é•¿",
                            value="ä¸€å‘¨å·¦å³",
                            elem_classes="large-input"
                        )
                        checklist_needs = gr.Textbox(
                            label="âš•ï¸ ç‰¹æ®Šéœ€æ±‚",
                            placeholder="å¦‚ï¼šæ…¢æ€§ç—…ç”¨è¯ã€åŒ»ç–—å™¨æ¢°ã€ç‰¹æ®Šé¥®é£Ÿç­‰",
                            elem_classes="large-input"
                        )
                        checklist_btn = gr.Button("ğŸ“‹ ç”Ÿæˆæ¸…å•", variant="primary", elem_classes="large-button")

                    with gr.Column(scale=1):
                        checklist_reasoning = gr.Textbox(
                            label="ğŸ¤” æ€è€ƒè¿‡ç¨‹",
                            lines=8,
                            max_lines=15,
                            elem_classes="large-textbox"
                        )
                        checklist_output = gr.Textbox(
                            label="âœ¨ æ¸…å•å†…å®¹",
                            lines=15,
                            max_lines=25,
                            elem_classes="output-box"
                        )

                checklist_btn.click(
                    fn=generate_checklist,
                    inputs=[checklist_dest, checklist_duration, checklist_needs],
                    outputs=[checklist_reasoning, checklist_output]
                )

                gr.HTML("""
                <div style="margin-top: 40px; padding: 30px; background-color: #e8f4f8; border-radius: 15px; border: 3px solid #667eea;">
                    <h3 style="font-size: 28px; color: #667eea; margin-bottom: 20px;">ğŸ†˜ ç´§æ€¥æ±‚åŠ©åŠŸèƒ½</h3>
                    <p style="font-size: 20px; line-height: 1.8; color: #333;">
                        <strong>ä¸€é”®æ±‚åŠ©æŒ‰é’®</strong>å°†åœ¨æ‚¨é‡åˆ°å›°éš¾æ—¶æä¾›å¿«é€Ÿå¸®åŠ©<br>
                        æ”¯æŒï¼šç´§æ€¥è”ç³»äººã€é™„è¿‘åŒ»é™¢ã€æŠ¥è­¦ç”µè¯ã€æ—…æ¸¸æŠ•è¯‰çƒ­çº¿
                    </p>
                    <button style="font-size: 24px; padding: 15px 30px; background-color: #ff4757; color: white; border: none; border-radius: 10px; margin-top: 15px; cursor: pointer;">
                        ğŸš¨ ç´§æ€¥æ±‚åŠ©
                    </button>
                </div>
                """)

            # Tab 3: æ—…è¡Œæ¸¸è®°ç”Ÿæˆ
            with gr.TabItem("ğŸ¬ æ—…è¡Œæ¸¸è®°ç”Ÿæˆ", id=3):
                gr.HTML('<div class="section-title">ğŸ“¸ ç…§ç‰‡ä¸Šä¼ ä¸æ¸¸è®°ç”Ÿæˆ</div>')

                with gr.Row():
                    with gr.Column(scale=1):
                        photo_input = gr.File(
                            file_count="multiple",
                            file_types=["image"],
                            label="ğŸ“· ä¸Šä¼ æ—…è¡Œç…§ç‰‡",
                            height=150
                        )
                        custom_story_input = gr.Textbox(
                            label="âœï¸ è¡¥å……ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰",
                            placeholder="åˆ†äº«æ‚¨çš„æ—…è¡Œæ„Ÿå—ã€ç‰¹æ®Šå›å¿†æˆ–æƒ³è¦å¼ºè°ƒçš„å†…å®¹...",
                            lines=6,
                            elem_classes="large-textbox"
                        )
                        story_btn = gr.Button("âœ¨ ç”Ÿæˆæ¸¸è®°", variant="primary", elem_classes="large-button")

                    with gr.Column(scale=1):
                        story_reasoning = gr.Textbox(
                            label="ğŸ¤” åˆ›ä½œæ€è€ƒ",
                            lines=8,
                            max_lines=15,
                            elem_classes="large-textbox"
                        )
                        story_output = gr.Textbox(
                            label="âœ¨ æ¸¸è®°å†…å®¹",
                            lines=15,
                            max_lines=25,
                            elem_classes="output-box"
                        )

                story_btn.click(
                    fn=generate_travel_story,
                    inputs=[photo_input, custom_story_input],
                    outputs=[story_reasoning, story_output]
                )

                gr.HTML('<div class="section-title">ğŸ¥ è§†é¢‘ç”Ÿæˆ</div>')

                with gr.Row():
                    with gr.Column(scale=1):
                        video_prompt = gr.Textbox(
                            label="ğŸ¬ è§†é¢‘ç”ŸæˆPrompt",
                            lines=5,
                            elem_classes="large-textbox"
                        )
                        edit_prompt = gr.Textbox(
                            label="âœï¸ ç¼–è¾‘Prompt",
                            lines=5,
                            elem_classes="large-textbox"
                        )
                        regenerate_btn = gr.Button("ğŸ”„ é‡æ–°ç”Ÿæˆå›¾ç‰‡", variant="secondary", elem_classes="large-button")

                    with gr.Column(scale=1):
                        image_output = gr.Image(
                            label="ğŸ–¼ï¸ ç”Ÿæˆçš„å›¾ç‰‡",
                            type="pil",
                            height=300
                        )

                regenerate_btn.click(
                    fn=regenerate_image,
                    inputs=[edit_prompt],
                    outputs=[image_output]
                )

        # é¡µè„š
        gr.HTML("""
        <div style="margin-top: 50px; padding: 30px; text-align: center; background-color: #f0f0f0; border-radius: 10px;">
            <p style="font-size: 18px; color: #666; line-height: 1.8;">
                â¤ï¸ ä¸“ä¸ºè€å¹´äººè®¾è®¡ Â· è®©ç§‘æŠ€æ¸©æš–é“¶å‘ç”Ÿæ´»<br>
                ğŸ›¡ï¸ æ•°æ®å®‰å…¨åŠ å¯† Â· ä¿æŠ¤æ‚¨çš„éšç§<br>
                ğŸ“ å¦‚éœ€å¸®åŠ©è¯·è”ç³»ï¼š400-XXX-XXXX
            </p>
        </div>
        """)

    return app

if __name__ == "__main__":
    app = create_app()
    app.launch(
        server_name="0.0.0.0",
        server_port=7860,
        share=False,
        show_error=True,
        inbrowser=True
    )
